<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Machine Learning, R Programming, Statistics, Artificial Intelligence">
    <meta name="author" content="Manuel Amunategui">
    <link rel="icon" href="../favicon.ico">

    <title>GPUs on Google Cloud - the Fast Way & the Slow Way</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../blog.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55202104-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-55202104-1');
  </script>

  </head>
<body>
  
 <div class="blog-masthead">
    <div class="container">
      <nav class="blog-nav">
        <a class="blog-nav-item active" href="../index.html">Home</a>
        <a class="blog-nav-item" href="https://www.linkedin.com/in/manuel-amunategui-20748923" target='_blank'>Linkedin</a>
        <a class="blog-nav-item" href="https://www.youtube.com/user/mamunate/videos" target='_blank'>Videos</a>
        <a class="blog-nav-item" href="https://github.com/amunategui/Feedback/issues/new" target='_blank'>Feedback</a>
      </nav>
    </div>
</div>

<div class="container">

  <div class="blog-header">
    <h1 class="blog-title">GPUs on Google Cloud - the Fast Way & the Slow Way</h1>
    <p class="lead blog-description">Practical walkthroughs on machine learning, data exploration and finding insight.</p>
  </div>
  

<p><strong>On YouTube:</strong></p>
<ul>
<li type="square"><a href="https://www.youtube.com/watch?v=W-FqRBoyTgw&list=UUq4pm1i_VZqxKVVOz5qRBIA&index=1" target="_blank"><img src="img/yelp-app-engine-youtube.jpg" alt="YouTube.com companion link" width="120" height="90" border="10" /></a></li>
</ul>
<BR><BR>
<p>
Here are the notes on two methods to get GPUs up-and-running for Tensorflow on Google Cloud. A quick one using pre-built Jetware instances, and one from scratch using a VM. 
</p>
<BR>
<p>Note: notes not meant to stand alone, use with corresponding <a href="https://www.youtube.com/watch?v=W-FqRBoyTgw&list=UUq4pm1i_VZqxKVVOz5qRBIA&index=1" target="_blank">video</a></p>
<BR><BR>
<H1>Method 1: Jetware Instances</H1>
<p style="text-align:center">
<img src="img/image001.png" alt="Jetware" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<H3>Enable GPU quotas</H3>
<p>
For either approach you need a credit-card enabled GCP account even if you are using free credits. You also need to change GPU Quotas to allow for at least one GPU. In the search bar in your Google Cloud Platform. Enable the GPU you want for your region. Click "EDIT QUOTAS", fill the form and wait for Google's green light.
</p>
<p style="text-align:center">
<img src="img/image002.png" alt="Quotas" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<p>
Type in GPU in the search bar and select the "Tensorflow NVidia GPU"
</p>
<p style="text-align:center">
<img src="img/image003.png" alt="Quotas" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<p>
Deploy your Jetware instance, hit the Jupyter button and tensor away!
</p>
<p style="text-align:center">
<img src="img/image004.png" alt="Jetware Instance" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<H1>Method 2: From Scratch</H1>
<p>
Let's do the above from scratch (big thanks to Eric Scuccimarra
https://medium.com/google-cloud/setting-up-tensorflow-gpu-on-google-cloud-instance-with-ubuntu-16-04-53cb6749b527)
</p>
<p>
You still need to enable GPUs and have a credit-card enabled account (see above for steps).
</p>
<p style="text-align:center">
<img src="img/image005.png" alt="Instance" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<p>Choose <b>Ubuntu 16.04</b> and an appropriate boot disk size. The create your instance. Get the instance started and click on 'Create'</p>
<p style="text-align:center">
<img src="img/image006.png" alt="Drives" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<p>Get cuDNN - You need to become a member of the "NVIDIA Developer Program" in order to get cuDNN, the "Deep Neural Network (cuDNN)" binaries. Signup at <a href='https://developer.nvidia.com/developer-program' target='_blank'>https://developer.nvidia.com/developer-program</a> and wait for your confirmation email.</p>
<p style="text-align:center">
<img src="img/image007.png" alt="Nvidia developer program" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
<p>Once you have access, click on <a href='https://developer.nvidia.com/developer-program' target='_blank'>Member area</a> 
Then select the <a href='https://developer.nvidia.com/accelerated-computing-toolkit' target='_blank'>Accelerated Computing Toolkit</a>
Finally, download the <a href='https://developer.nvidia.com/rdp/cudnn-download'>GPU-Accelerated Libraries Deep Neural Network (cuDNN) binaries</a>.
<BR><BR>
I went with "libcudnn7_7.1.4.18-1%2Bcuda9.0_amd64.deb"
</p>

<p>You are ready, fire up your instance by clicking the "SSH" button.</p>
<p style="text-align:center">
<img src="img/image008.png" alt="Nvidia developer program" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>
Upload the (cuDNN) file using upload gear button.
<p style="text-align:center">
<img src="img/image009.png" alt="Nvidia developer program" style='padding:1px; border:1px solid #021a40; width: 80%; height: 80%'>
</p>
<BR><BR>

Run the following commands to update <b>apt-get</B>, run as root, and install Nvidia's CUDA software:
```{r eval=FALSE}

# update apt-get
sudo apt-get update
 
# work as root
sudo su

#!/bin/bash
echo "Checking for CUDA and installing."
# Check for CUDA and try to install.
if ! dpkg-query -W cuda; then
    curl -O https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1604/x86_64/cuda-repo-ubuntu1604_9.0.176-1_amd64.deb
    sudo dpkg -i cuda-repo-ubuntu1604_9.0.176-1_amd64.deb
    sudo apt-get update
    sudo apt-get install cuda-9-0
    sudo nvidia-smi -pm 1
fi
```
Test that your GPU is sucessfully installed:
```{r eval=FALSE}
# check that GPU is working
nvidia-smi
```


Deep Neural Network (cuDNN)
libcudnn7_7.1.4.18-1%2Bcuda9.0_amd64.deb





Test out the instance using GPU code (see code at: https://www.tensorflow.org/programmers_guide/using_gpu)




sudo dpkg -i libcudnn7_7.1.4.18-1+cuda9.0_amd64.deb

# sticky path defaults
echo 'export CUDA_HOME=/usr/local/cuda' >> ~/.bashrc
echo 'export PATH=$PATH:$CUDA_HOME/bin' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda/extras/CUPTI/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc


# Install tensorflow
sudo apt-get install python3-dev python3-pip libcupti-dev

# install tensorflow-gpu
sudo pip3 install tensorflow-gpu


# install ipython3
apt install ipython3

Testing code

# https://www.tensorflow.org/programmers_guide/using_gpu
# Creates a graph.
with tf.device('/gpu:0'):
  a = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[2, 3], name='a')
  b = tf.constant([1.0, 2.0, 3.0, 4.0, 5.0, 6.0], shape=[3, 2], name='b')
c = tf.matmul(a, b)
# Creates a session with log_device_placement set to True.
sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
# Runs the op.
print(sess.run(c))




 
</div>
</body>
</html>
